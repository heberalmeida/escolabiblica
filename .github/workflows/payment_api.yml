name: ğŸš€ Deploy Laravel

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v3

      - name: ğŸ” Detectar mudanÃ§as
        id: changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            api:
              - 'backend/**'
            composer:
              - 'backend/composer.json'
              - 'backend/composer.lock'

      - name: â­ï¸ Sem mudanÃ§as em payment_api â€” pulando deploy
        if: steps.changes.outputs.api != 'true'
        run: echo "Sem mudanÃ§as em payment_api/**. Skipping deploy."

      - name: ğŸ“¦ Deploy cÃ³digo via SSH
        if: steps.changes.outputs.api == 'true'
        uses: appleboy/scp-action@master
        with:
          host: 23.108.108.219
          username: heber
          password: ${{ secrets.SSH_PASS }}
          port: 22
          source: "backend/**"
          target: "/home/heber/apis/payment_api"
          overwrite: true
          strip_components: 1

      - name: ğŸš€ Rodar comandos no servidor
        if: steps.changes.outputs.api == 'true'
        uses: appleboy/ssh-action@master
        with:
          host: 23.108.108.219
          username: heber
          password: ${{ secrets.SSH_PASS }}
          port: 22
          script: |
            cd /home/heber/apis/payment_api

            # roda composer somente no primeiro deploy ou se houve mudanÃ§as no composer.*
            if [[ "${{ steps.changes.outputs.composer }}" == "true" ]] || [ ! -d vendor ]; then
              composer83 install --no-dev --optimize-autoloader
            fi

            php83 artisan config:cache
            php83 artisan route:cache
            php83 artisan view:cache

            chmod -R 775 storage bootstrap/cache
