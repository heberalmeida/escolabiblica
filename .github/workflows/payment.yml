name: ğŸš€ Deploy Front (frontend)

on:
  push:
    branches:
      - main

jobs:
  deploy-front:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v3

      - name: ğŸ” Detectar mudanÃ§as no frontend
        id: changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            front:
              - 'frontend/**'

      - name: â­ï¸ Sem mudanÃ§as em frontend â€” pulando
        if: steps.changes.outputs.front != 'true'
        run: echo "Sem mudanÃ§as em frontend/**. Skipping build & deploy."

      - name: ğŸ§° Node.js 22
        if: steps.changes.outputs.front == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '22.17.1'

      - name: ğŸ“¦ Yarn
        if: steps.changes.outputs.front == 'true'
        run: npm install -g yarn

      - name: âš™ï¸ Build (Vite)
        if: steps.changes.outputs.front == 'true'
        working-directory: frontend
        run: |
          yarn install --frozen-lockfile
          # Garante que nada local sobrescreva as variÃ¡veis no CI
          rm -f .env.local
          # Build em modo "prod" para usar .env.prod
          yarn build:prod

      - name: ğŸ§¹ Limpar destino antes do deploy
        if: steps.changes.outputs.front == 'true'
        uses: appleboy/ssh-action@master
        with:
          host: 23.108.108.219
          username: heber
          password: ${{ secrets.SSH_PASS }}
          port: 22
          script: |
            rm -rf /home/heber/apps/payment/*

      - name: ğŸ“¤ Deploy dist via SCP
        if: steps.changes.outputs.front == 'true'
        uses: appleboy/scp-action@master
        with:
          host: 23.108.108.219
          username: heber
          password: ${{ secrets.SSH_PASS }}
          port: 22
          source: "frontend/dist/**"
          target: "/home/heber/apps/payment"
          overwrite: true
          strip_components: 2
